<html>

<head>
  <title>SignedURL upload/downlaod</title>

  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.green-light_green.min.css" />
  <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

  <link rel="stylesheet" href="/public/style.css">
</head>

<body>



  <div class="mdl-layout-spacer"></div>

  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
    <input class="mdl-textfield__input" type="text" id="gsfilename" name="gsfilename" value="README.md">
    <label class="mdl-textfield__label" for="gsfilename">FileName:</label>
  </div>

  <div class="mdl-layout-spacer"></div>

  <div class="mdl-layout-spacer"></div>

  <div class="mdl-textfield mdl-js-textfield mdl-textfield--file">
    <input type="file" id="selector">
  </div>

  <input class="mdl-button mdl-button--raised mdl-button--colored" type="button" value="Upload" onclick="generateSignedURL()">


  <br />


  <div class="mdl-textfield mdl-js-textfield mdl-textfield--file" id="status"></div>


  <script src="//code.jquery.com/jquery-3.1.0.min.js"></script>
  <script type="text/javascript">

    var c = "";

    function upload() {
      var file = $('#selector')[0].files[0];
      uploadFile(file)
    }


    async function generateSignedURL() {
      file = $('input[name="gsfilename"]').val();
      action = "PUT";
      const response = await fetch('/getSignedURL?filename=' + file + "&action=" + action)
      if (!response.ok) {
        throw new Error('Network response for fetch was not ok.');
      }
      c = await response.text();
      c = c.replace(/\"/g, "")
      console.log("Got signedURL: " + c)
      console.log("Trying to upload")
      upload();
      console.log("Complete")
      return false;
    }

    function uploadFile(file) {
      $("#status").html('Starting Upload...')
      url = c
      fetch(url, {
        method: 'PUT',
        body: file
      })
        .then(response => response.text())
        .catch(error => $("#status").html(error)
        )
        .then(response => $("#status").html('File uploaded successfully'));
    }

  </script>


</body>

</html>